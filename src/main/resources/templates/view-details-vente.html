<!DOCTYPE html>
<html lang="fr"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.w3.org/1999/xhtml"
      data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Enchères - Détail vente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/darkly/bootstrap.min.css" rel="stylesheet">
    <link href="/css/general.css" rel="stylesheet">
</head>
<body>
<header data-th-replace="~{fragments/entete :: frag-entete }"></header>

<main class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">

            <!-- Bloc informations article -->
            <div class="border rounded p-4 shadow mb-4">
                <h1 class="text-center mb-4 text-warning">Détail vente</h1>
                <h2 class="text-center mb-4" th:text="${article.getNomArticle()}"></h2>

                <div class="row mb-3">
                    <div class="col-6 text-end fw-bold">Description :</div>
                    <div class="col-6 text-start" th:text="${article.getDescription()}"></div>
                </div>

                <div class="row mb-3">
                    <div class="col-6 text-end fw-bold">Catégorie :</div>
                    <div class="col-6 text-start" th:text="${@categorieServiceImpl.findCategorieById(article.categorieArticle.getNoCategorie()).libelle}"></div>
                </div>

                <div class="row mb-3">
                    <div class="col-6 text-end fw-bold">Meilleure offre :</div>
                    <div class="col-6 text-start">
                        <span th:if="${article.getPrixVente()==0}" th:text="${article.getMiseAPrix() + ' points'}"></span>
                        <span th:unless="${article.getPrixVente()==0}" th:text="${article.getPrixVente() + ' points'}"></span>
                        par
                        <span th:if="${article.getPrixVente()==0}" th:text="${@utilisateurServiceImpl.findUserById(article.utilisateur.noUtilisateur).pseudo}"></span>
                        <span th:unless="${article.getPrixVente()==0}" th:text="${@utilisateurServiceImpl.findUserById(bestBidder.noUtilisateur).pseudo}"></span>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-6 text-end fw-bold">Mise à prix :</div>
                    <div class="col-6 text-start" th:text="${article.getMiseAPrix() + ' points'}"></div>
                </div>

                <div th:if="${article.dateDebutEnchere != null and article.dateDebutEnchere.isAfter(#temporals.createNow())}" class="row mb-3">
                    <div class="col-6 text-end fw-bold">Date début enchère :</div>
                    <div class="col-6 text-start">
                        <span th:text="${#temporals.format(article.dateDebutEnchere, 'dd/MM/yyyy') + ' - ' + #temporals.format(article.dateDebutEnchere, 'HH:mm')}" ></span>
                    </div>
                </div>

                <div th:if="${article.dateDebutEnchere != null and article.dateDebutEnchere.isBefore(#temporals.createNow())}" class="row mb-3">
                    <div class="col-6 text-end fw-bold">Enchère ouverte depuis :</div>
                    <div class="col-6 text-start">
                        <span th:text="${#temporals.format(article.dateDebutEnchere, 'dd/MM/yyyy') + ' - ' + #temporals.format(article.dateDebutEnchere, 'HH:mm')}" ></span>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-6 text-end fw-bold">Fin de l'enchère :</div>
                    <div class="col-6 text-start">
                        <span th:text="${#temporals.format(article.dateFinEnchere, 'dd/MM/yyyy')}"></span>
                        à
                        <span th:text="${#temporals.format(article.dateFinEnchere, 'HH:mm')}"></span>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-6 text-end fw-bold">Retrait :</div>
                    <div class="col-6 text-start">
                        <span th:if="${retrait != null}">
                        <span th:text="${retrait.rue}"></span><br/>
                        <span th:text="${retrait.cp + ' ' + retrait.ville}"></span>
                        </span>
                        <span th:if="${retrait == null}">Aucune adresse de retrait spécifiée</span>
                </div>

                <div class="row mt-4">
                    <div class="col-6 text-end fw-bold">Vendeur :</div>
                    <div class="col-6 text-start" th:text="${@utilisateurServiceImpl.findUserById(article.utilisateur.noUtilisateur).pseudo}"></div>
                </div>
            </div>
            <div th:if="${@articleVenduServiceImpl.articleEstVendu(article.getNoArticle())}" class="text-center mb-3">
                <span class="text-warning">Vente terminée. </span>
                <span class="text-warning" th:if="${bestBidder == null && #authentication.name == @utilisateurServiceImpl.findUserById(article.utilisateur.noUtilisateur).pseudo}">
                    Aucune enchère n'a été faite.
                </span>
                <span class="text-warning" th:if="${bestBidder != null && #authentication.name == @utilisateurServiceImpl.findUserById(article.utilisateur.noUtilisateur).pseudo}">
                    , remportée par
                    <a th:href="@{/profilVendeur/{pseudo}(pseudo=${@utilisateurServiceImpl.findUserById(bestBidder.noUtilisateur).pseudo})}"
                       th:text="${@utilisateurServiceImpl.findUserById(bestBidder.noUtilisateur).pseudo}"
                       class="link-offset-2 link-underline link-underline-opacity-75"
                       sec:authorize="isAuthenticated()"></a>
                </span>
                <div th:if="${bestBidder != null && #authentication.name == @utilisateurServiceImpl.findUserById(bestBidder.noUtilisateur).pseudo}">
                    <span>Vous avez remporté l'enchère ! Contactez le vendeur :</span>
                    <span th:text="${@utilisateurServiceImpl.findUserById(article.utilisateur.noUtilisateur).telephone}"></span>
                </div>

            </div>

            <div th:if="${!@articleVenduServiceImpl.articleEstVendu(article.noArticle) and article.dateDebutEnchere.isBefore(#temporals.createNow())}" class="text-center mb-3">
                <span class="text-warning">Vente en cours</span>

            <!-- Formulaire d'enchère -->
            <div th:if="${#authentication.name}!=${@utilisateurServiceImpl.findUserById(article.utilisateur.noUtilisateur).pseudo}">
                <form th:action="@{/detail-vente/{id}(id=${article.getNoArticle()})}" method="POST"
                      class="border rounded p-4 shadow mb-4">

                    <!-- CSRF -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                    <h4 class="text-center mb-3">Proposer une enchère</h4>

                    <div class="row mb-3">
                        <label for="inputEnchere" class="col-4 col-form-label text-end">Montant :</label>
                        <div class="col-6">
                            <input type="number" class="form-control"
                                   id="inputEnchere"
                                   name="montant"
                                   th:min="${article.getMiseAPrix() + 1}"
                                   th:placeholder="${article.getPrixVente() + 1}"
                                   required>
                        </div>
                    </div>

                    <div class="text-center">
                        <button type="submit" class="btn btn-success px-4">Enchérir</button>
                    </div>
                </form>
            </div>
            </div>
            <!-- Message de succès -->
            <div th:if="${successMessage}" class="alert alert-success text-center mt-4">
                <span th:text="${successMessage}"></span>
            </div>

        </div>
    </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
